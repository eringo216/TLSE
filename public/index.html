<!DOCTYPE html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title>Tameiki-Logger Socket.io Edition</title>
</head>
<link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="dark.css" id="theme-style">
<body text="FFFFFF" bgcolor="222222">
	<script src="/socket.io/socket.io.js"></script>
	<script>
	const socket = io('http://nubesuko.ddns.net:666');
	var chatid = 21547364;
	var chatview;
	var inputid;
	var inputng;
	var NGwords;
	var dousetu;
	var themeStyle;
	var olddup = 0;


	//èª­ã¿è¾¼ã¿æ™‚
	document.addEventListener('DOMContentLoaded', () => {
		chatview = document.getElementById("chatview");
		idview = document.getElementById("idview");
		eventview = document.getElementById("console");
		inputid = document.getElementById("inputid");
		inputng = document.getElementById("inputng");
		dousetu = document.getElementById("dousetu");
		isgroup = document.getElementById("isgroup");
		themeStyle = document.getElementById('theme-style');
		restoreInputField();
	});

	//ãƒ­ã‚°å—ä¿¡[{ message: string, timestamp: Date , dup: suuji}]
	socket.on('fc2chatlog', (chatMessages) => {

		chatMessages.forEach(chatMsg => {
			const message = chatMsg.message;
			const timestamp = new Date(chatMsg.timestamp).toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo', year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit'});

			// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡¨ç¤ºéƒ¨åˆ†
			let msg = '<div class="message">' + message + 
						'<div class="other">' + 
						'<b class="time">' + timestamp + '</b>' + 
						'</div>' + 
						'</div>';
			
			// dupã®è¡¨ç¤º
			if (isgroup.checked && chatMsg.dup > 1) {
				console.log(chatMsg.dup);
				// é€£æŠ•ã‚«ã‚¦ãƒ³ãƒˆã‚’è¡¨ç¤º

				if(document.getElementsByClassName('message')[0] && document.getElementsByClassName("message")[0].children[0].tagName !== "A"){
					if (chatMsg.dup == 2){
						document.getElementsByClassName('other')[0].insertAdjacentHTML('beforeBegin', '<p class="dup">x' + chatMsg.dup + '</p>');
					} else {
						document.getElementsByClassName('message')[0].children[0].textContent = `x${chatMsg.dup}`;
						olddup = chatMsg.dup;
					}
				} 
			} else {
				// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
				chatview.insertAdjacentHTML('afterbegin', msg);
				console.log(message);
			}
		});
	});


	//ã©ã†ã›ã¤
	socket.on('dousetu',(a,names) => {
		dousetu.textContent = `æ¥ç¶šè€…æ•°:${a}(${names})`
	})

	//ã‚¤ãƒ™ãƒ³ãƒˆè¡¨ç¤º
	socket.on('event', (data) => {
		console.log(data.msg);

		// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è‰²ä»˜ãã§æŒ¿å…¥
		const type = data.type === "error" ? 'error' : 'info'; // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯èµ¤ã€ãã‚Œä»¥å¤–ã¯é’
		
		eventview.insertAdjacentHTML('afterbegin', `<div class="${type}">${data.msg}<br></div>`);

		if(Object.keys(data).includes("id")){
			idview.textContent = `ID:${data.id}`;
		}
	});

	//Cookieèª­ã¿è¾¼ã¿
	function restoreInputField() {
		const cookies = document.cookie.split('; ');
		let idFound = false;
		
		for (const cookie of cookies) {
			const [name, value] = cookie.split('=');
			if (name === 'id') {
				socket.emit('readconfig', parseInt(value));
				chatid = value;
				inputid.value = value;
				idFound = true;
			}
			if (name === 'fc2chatname') {
				document.getElementById("sendname").value = value;
				socket.emit("sendname",value);
			}
			if (name === 'NGwords') {
				if (value.length !== 0) {
					NGwords = decodeURIComponent(value).split(',');
					inputng.value = decodeURIComponent(value);
				}
			}
			if (name === 'theme') {
				themeStyle.href = value;
			}
			if (name === 'textsize') {
				var textsize = document.getElementById("textsize");
				chatview.setAttribute("style", `font-size:${value}px`);
				textsize.value = value;
			}
			if (name === 'isgroup') {
				var isgroup = document.getElementById("isgroup");
				isgroup.checked = value;
				isgroup.value = value;
			}
		}

		if (!idFound) {
			console.log("id CookieãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã£ã—ãŸ");
			socket.emit('readconfig', 21547364);
		}
	}


	function shoutKey(){
		// ENTERãªã‚‰
		if (window.event.keyCode == 13 && document.getElementById('sendmsg').value != '')
		{
			Shout();
		}
	}

	function setId(){
		document.cookie = 'id=' + inputid.value + '; expires=Fri, 31 Dec 9999 23:59:59 GMT; path=/';
		chatid = inputid.value;
		if (inputid.value != null){
			socket.emit('readconfig',parseInt(inputid.value));
		}
	}

	//NGãƒ¯ãƒ¼ãƒ‰
	function setNG(){
		if(inputng.value.length != 0){
			NGwords = inputng.value.split(",");
		} else {
			NGwords = [];
		}
		document.cookie = 'NGwords=' + encodeURIComponent(inputng.value) + '; expires=Fri, 31 Dec 9999 23:59:59 GMT; path=/';
	}

	
	//ç™ºè¨€
	function Shout(){
		const bunkatsu = false;
		const name    = document.getElementById('sendname').value;
		const message = document.getElementById('sendmsg').value;
		const alltext = [name,message];
		document.cookie = 'fc2chatname=' + name + '; expires=Fri, 31 Dec 9999 23:59:59 GMT; path=/';
		const autoclear = document.querySelector('#autoclear');

		 // ãƒ‡ãƒ¼ã‚¿é‡ã®ã‚«ã‚¦ãƒ³ãƒˆ
		let nameSize = 0;
		let textSize = 0;

		for (let i = 0; i < 2; i++) {
			for (const char of alltext[i]) {
				const codePoint = char.codePointAt(0);

				// çµµæ–‡å­—ã®å‡¦ç†ï¼ˆãƒ‡ãƒ¼ã‚¿é‡9ï¼‰
				if (char.match(/\p{Emoji_Presentation}/u)) {
					if(i==0){
						nameSize += 9;
					}
					if(i==1){
						textSize += 9;
					}
				}
				// å…¨è§’æ–‡å­—ã®å‡¦ç†ï¼ˆãƒ‡ãƒ¼ã‚¿é‡2ï¼‰
				else if (codePoint > 0x7F) {
					if(i==0){
						nameSize += 2;
					}
					if(i==1){
						textSize += 2;
					}
				}
				// åŠè§’æ–‡å­—ã®å‡¦ç†ï¼ˆãƒ‡ãƒ¼ã‚¿é‡1ï¼‰
				else {
					if(i==0){
						nameSize += 1;
					}
					if(i==1){
						textSize += 1;
					}
				}
			}
		}

		if (!bunkatsu){
			// ãƒ‡ãƒ¼ã‚¿é‡ãŒ100ã‚’è¶…ãˆãŸã‚‰é€ä¿¡ä¸å¯
			if (nameSize > 20) {
				eventview.insertAdjacentHTML('afterbegin', `<div class="error">åå‰ã®ãƒ‡ãƒ¼ã‚¿é‡ãŒå¤šã„ã®ã§é€ä¿¡ã§ãã¾ã›ã‚“ã€‚ã‚ã¨${20-nameSize}(åŠè§’1,å…¨è§’2,çµµæ–‡å­—9)æ¸›ã‚‰ã—ã¦ãã ã•ã„ã€‚<br></div>`);
				return; // å‡¦ç†ã‚’ä¸­æ–­
			}

			if (textSize > 100) {
				eventview.insertAdjacentHTML('afterbegin', `<div class="error">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒ‡ãƒ¼ã‚¿é‡ãŒå¤šã„ã®ã§é€ä¿¡ã§ãã¾ã›ã‚“ã€‚ã‚ã¨${100-textSize}(åŠè§’1,å…¨è§’2,çµµæ–‡å­—9)æ¸›ã‚‰ã—ã¦ãã ã•ã„ã€‚<br></div>`);
				return; // å‡¦ç†ã‚’ä¸­æ–­
			}

			if(autoclear.checked){
				document.getElementById('sendmsg').value = '';
			}
		}

		socket.emit('shout',name,message);
	}

	// æ–‡å­—ã‚µã‚¤ã‚ºå¤‰æ›´
	function changetextsize(){
		var textsize = document.getElementById("textsize").value;
		chatview.setAttribute("style", `font-size:${textsize}px`);
		document.cookie = 'textsize=' + textsize + '; expires=Fri, 31 Dec 9999 23:59:59 GMT; path=/';
		localStorage.setItem('textsize', textsize);
	}

	function tukaen(){
		chatview.insertAdjacentHTML('afterbegin','<div class="tukaen">ã„ã¾ã¯ã¤ã‹ãˆã¾ã—ã‡ãƒ¼ãƒ¼ãƒ¼ãƒ¼ãƒ¼ã‚“</div>');
	}

	function toggleGroup(){
		if(isgroup.checked){
			isgroup.checked = !isgroup.checked;
		}
		document.cookie = 'isgroup=' + isgroup.checked + '; expires=Fri, 31 Dec 9999 23:59:59 GMT; path=/';
	}

	function toggletheme(){
		if (themeStyle.href.includes('dark')) {
			themeStyle.href = 'light.css';
			document.cookie = 'theme=' + 'light.css' + '; expires=Fri, 31 Dec 9999 23:59:59 GMT; path=/';
			localStorage.setItem('theme', 'light');
		} else {
			themeStyle.href = 'dark.css';
			document.cookie = 'theme=' + 'dark.css' + '; expires=Fri, 31 Dec 9999 23:59:59 GMT; path=/';
			localStorage.setItem('theme', 'dark');
		}
	}
	
	</script>
<div class="top">
  	<details id="explain">
    	<summary style="justify-content: left;">èª¬æ˜</summary>
    	ã“ã‚Œã‚’é–‹ã„ã¦ã‚‹é–“ã€ã²ã¨ã„ãã§é€ä¿¡ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè“„ç©ã•ã‚Œã¾ã™ã€‚<br>
    	æ–‡å­—ã‚µã‚¤ã‚º:12~30px<br>
    	idã¯21547364(ã²ã¨ã„ã),5554406(ãƒ•ãƒ©ã‚²),36568320(ç§ã®ã‚„ã¤)
  	</details>
<details id="settings" class="container">
	<summary>âš™ï¸ è¡¨ç¤ºè¨­å®š</summary>
	<div class="content">
		<div class="options">
			<label for="textsize">æ–‡å­—ã‚µã‚¤ã‚º</label>
			<input type="range" min="12" max="30" step="1" id="textsize" value="12" oninput="changetextsize()">
		</div>

		<div class="options">
			<label for="inputng">NGãƒ¯ãƒ¼ãƒ‰</label>
			<input type="text" id="inputng">
			<button class="sendbtn" onclick="setNG()">è¨­å®š</button>
		</div>

		<div class="options">
			<label for="inputng">é€£æŠ•ã‚’çºã‚ã‚‹</label>
			<input type="checkbox" id="isgroup" onclick="toggleGroup()">
		</div>

		<div class="options">
			<button class="sendbtn toggle-btn" onclick="toggletheme()">ğŸŒ— ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆ</button>
		</div>
	</div>
</details>
<details id="idarea" class="container">
	<summary id="idview">ID:21547364</summary>
	<div class="content">
		<input type="number" id="inputid" value="21547364">
		<input type="button" class="sendbtn" value="è¨­å®š" onclick="setId()">
	</div>
</div><br>
<div id="inputarea" class="container">
	<input type="text" id="sendname">
	<input type="text" id="sendmsg" onkeypress="shoutKey()">
	<input type="button" class="sendbtn" value="é€ä¿¡" onclick="Shout()">
	<div>
		<input type="checkbox" id="revtext">æ–‡å­—åè»¢
	</div>
	<div>
		<input type="checkbox" id="autoclear" checked>è‡ªå‹•æ¶ˆå»
	</div>
</div>
<div id="chatview" class="view" style="font-size:17px"></div>
<div id="bottom">
	<div id="console" class="view"></div>
	<input type="button" id="nomean" class="sendbtn" style="display:none;" value="ç‰¹ã«æ„å‘³ã®ãªã„ãƒœã‚¿ãƒ³" onclick="tukaen()">
</div>
<div>Made by eringo216</div><div id="dousetu">æ¥ç¶šè€…æ•°:</div>
</body>
</html>